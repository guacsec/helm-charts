# GUAC Helm Chart

This is a [Helm Chart](https://helm.sh/docs/topics/charts/) for deploying [GUAC](https://github.com/guacsec/guac) to [Kubernetes](https://kubernetes.io/).  This chart offers the following features
* Neo4j deployment - community or enterprise
  

## Prerequisites

* Kubernetes 1.19+
* Helm v3.9.4+

## Install

`helm install --name guac guac-helm-chart`

## Uninstall

`helm delete guac`

## Parameters

### Global parameters

| Name                       | Description                                    | Value             |
| -------------------------- | ---------------------------------------------- | ----------------- |
| `imagePullSecrets[0].name` | Docker registry secret name for pulling images | `imagepullsecret` |

### Guac

This section contains parameters for configuring the different GUAC components.  

| Name                                                        | Description                                                                      | Value                                                |
| ----------------------------------------------------------- | -------------------------------------------------------------------------------- | ---------------------------------------------------- |
| `guac.workingDir`                                           | Working Directory for GUAC                                                       | `/guac`                                              |
| `guac.observability.deployServiceMonitor`                   | Boolean Deploy the service monitor for observability                             | `false`                                              |
| `guac.ociCollector.name`                                    | String Name of the OCI Collector component.                                      | `oci-collector`                                      |
| `guac.ociCollector.annotations.reloader.stakater.com/auto`  | Boolean for deploying [stakater/Reloader] (https://github.com/stakater/Reloader) | `""`                                                 |
| `guac.ociCollector.replicas`                                | Number of replicas for oci collector deployment                                  | `1`                                                  |
| `guac.ociCollector.image.repository`                        | Path to the OCI Collector image                                                  | `ghcr.io/kusaridev/local-organic-guac`               |
| `guac.ociCollector.image.tag`                               | Tag if using an image tag.  Optional                                             | `""`                                                 |
| `guac.ociCollector.image.digest`                            | Sha256 Image Digest.  It is strongly recommended to use this for verification.   | `""`                                                 |
| `guac.ociCollector.image.pullPolicy`                        | ImagePullPolicy for kubernetes                                                   | `IfNotPresent`                                       |
| `guac.ociCollector.image.command`                           | Command for the OCI Collector image.  It is not recommended to override this.    | `["sh","-c","/opt/guac/collector image --use-csub"]` |
| `guac.ingestor.name`                                        | String Name of the ingestor component.                                           | `ingestor`                                           |
| `guac.ingestor.annotations.reloader.stakater.com/auto`      | Boolean for deploying [stakater/Reloader] (https://github.com/stakater/Reloader) | `""`                                                 |
| `guac.ingestor.replicas`                                    | Number of replicas for ingestor deployment                                       | `1`                                                  |
| `guac.ingestor.image.repository`                            | Path to the Ingestor image                                                       | `ghcr.io/kusaridev/local-organic-guac`               |
| `guac.ingestor.image.tag`                                   | Tag if using an image tag.  Optional                                             | `""`                                                 |
| `guac.ingestor.image.digest`                                | Sha256 Image Digest.  It is strongly recommended to use this for verification.   | `""`                                                 |
| `guac.ingestor.image.pullPolicy`                            | ImagePullPolicy for kubernetes                                                   | `IfNotPresent`                                       |
| `guac.ingestor.image.command`                               | Command for the ingestor image.  It is not recommended to override this.         | `["sh","-c","/opt/guac/ingest ingest"]`              |
| `guac.collectSub.name`                                      | String Name of the Collector Sub component.                                      | `collectsub`                                         |
| `guac.collectSub.annotations.reloader.stakater.com/auto`    | Boolean for deploying [stakater/Reloader] (https://github.com/stakater/Reloader) | `""`                                                 |
| `guac.collectSub.replicas`                                  | Number of replicas for Collector Sub deployment                                  | `1`                                                  |
| `guac.collectSub.image.repository`                          | Path to the Collector Sub image                                                  | `ghcr.io/kusaridev/local-organic-guac`               |
| `guac.collectSub.image.tag`                                 | Tag if using an image tag.  Optional                                             | `""`                                                 |
| `guac.collectSub.image.digest`                              | Sha256 Image Digest.  It is strongly recommended to use this for verification.   | `""`                                                 |
| `guac.collectSub.image.pullPolicy`                          | ImagePullPolicy for kubernetes                                                   | `IfNotPresent`                                       |
| `guac.collectSub.image.command`                             | Command for the Collector Sub image.  It is not recommended to override this.    | `["sh","-c","/opt/guac/guacone csub-server"]`        |
| `guac.collectSub.image.ports[0].containerPort`              | Port the Collector Sub listens on                                                | `2782`                                               |
| `guac.graphqlServer.name`                                   | String Name of the GraphQL Server component.                                     | `graphql-server`                                     |
| `guac.graphqlServer.annotations.reloader.stakater.com/auto` | Boolean for deploying [stakater/Reloader] (https://github.com/stakater/Reloader) | `""`                                                 |
| `guac.graphqlServer.replicas`                               | Number of replicas for GraphQL Server deployment                                 | `1`                                                  |
| `guac.graphqlServer.image.repository`                       | Path to the GraphQL Server image                                                 | `ghcr.io/kusaridev/local-organic-guac`               |
| `guac.graphqlServer.image.tag`                              | Tag if using an image tag.  Optional                                             | `""`                                                 |
| `guac.graphqlServer.image.digest`                           | Sha256 Image Digest.  It is strongly recommended to use this for verification.   | `""`                                                 |
| `guac.graphqlServer.image.pullPolicy`                       | ImagePullPolicy for kubernetes                                                   | `IfNotPresent`                                       |
| `guac.graphqlServer.image.command`                          | Command for the GraphQL Server image.  It is not recommended to override this.   | `["sh","-c","/opt/guac/guacone gql-server"]`         |
| `guac.graphqlServer.image.ports[0].containerPort`           | Port the GraphQL Server listens on                                               | `8080`                                               |
| `guac.sampleData.ingest`                                    | Boolean - set to true to ingest sample data after deployment                     | `true`                                               |
| `guac.sampleData.jobName`                                   | Name of the sample data ingest job                                               | `ingest-sample-data`                                 |

### neo4j

This is the configuration for neo4j if being used.  This is a subchart.  See full documentation [here](https://neo4j.com/labs/neo4j-helm/1.0.0/).  

| Name                                                   | Description                                                       | Value                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| ------------------------------------------------------ | ----------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `neo4j.neo4j.name`                                     | Name of the neo4j instance                                        | `guac-neo4j`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| `neo4j.neo4j.password`                                 | Initial password for neo4j instance                               | `s3cr3ts3cr3t`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `neo4j.neo4j.edition`                                  | Type of instance being used.  Example "community" or "enterprise" | `community`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `neo4j.neo4j.labels.release`                           | Label for release.  This is used as part of monitoring            | `monitoring`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| `neo4j.neo4j.labels.app.kubernetes.io/part-of`         | Label to associate neo4j as part of GUAC for monitoring purposes. | `{"neo4j":{"name":"guac-neo4j","password":"s3cr3ts3cr3t","edition":"community","labels":{"release":"monitoring","app.kubernetes.io/part-of":"guac"},"resources":{"cpu":"1000m","memory":"4Gi"}},"services":{"neo4j":{"spec":{"type":"ClusterIP"}}},"config":{"server.directories.plugins":"/var/lib/neo4j/labs","dbms.security.procedures.unrestricted":"apoc.*","server.config.strict_validation.enabled":"false","dbms.security.procedures.allowlist":"gds.*,apoc.*","server.metrics.enabled":"true","server.metrics.prometheus.enabled":"true","server.metrics.prometheus.endpoint":"0.0.0.0:2004"},"jvm":{"additionalJvmArguments":["-XX:+HeapDumpOnOutOfMemoryError","-XX:HeapDumpPath=/logs/neo4j.hprof"]},"volumes":{"data":{"mode":"dynamic","dynamic":{"storageClassName":"standard","requests":{"storage":"100Gi"}}}}}` |
| `neo4j.neo4j.resources.cpu`                            | CPU allocation for neo4j                                          | `1000m`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| `neo4j.neo4j.resources.memory`                         | Memory allocation for neo4j                                       | `4Gi`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| `neo4j.services.neo4j.spec.type`                       | Kubernetes service type for neo4j service                         | `ClusterIP`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `neo4j.config.server.directories.plugins`              | Plugin directory for any neo4j plugins (i.e. APOC)                | `/var/lib/neo4j/labs`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| `neo4j.config.dbms.security.procedures.unrestricted`   | TODO                                                              | `apoc.*`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| `neo4j.config.server.config.strict_validation.enabled` | Boolean for strict validation                                     | `{"server.directories.plugins":"/var/lib/neo4j/labs","dbms.security.procedures.unrestricted":"apoc.*","server.config.strict_validation.enabled":"false","dbms.security.procedures.allowlist":"gds.*,apoc.*","server.metrics.enabled":"true","server.metrics.prometheus.enabled":"true","server.metrics.prometheus.endpoint":"0.0.0.0:2004"}`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| `neo4j.config.dbms.security.procedures.allowlist`      | Procedures which should be allowed to execute.                    | `gds.*,apoc.*`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `neo4j.config.server.metrics.enabled`                  | Boolean to turn on server metrics.                                | `true`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `neo4j.config.server.metrics.prometheus.enabled`       | Boolean to turn on prometheus                                     | `true`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `neo4j.config.server.metrics.prometheus.endpoint`      | Endpoint location for prometheus                                  | `0.0.0.0:2004`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `neo4j.jvm.additionalJvmArguments`                     | JVM Arguments for the neo4j server.                               | `["-XX:+HeapDumpOnOutOfMemoryError","-XX:HeapDumpPath=/logs/neo4j.hprof"]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `neo4j.volumes.data.mode`                              | Data mode for neo4j volume mount.                                 | `dynamic`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| `neo4j.volumes.data.dynamic.storageClassName`          | Storage class for neo4j volume mount.                             | `standard`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `neo4j.volumes.data.dynamic.requests.storage`          | Size of neo4j volume mount.                                       | `100Gi`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |

### neo4j

This is the configuration for nats.  This is a subchart.  See full documentation [here](https://docs.nats.io/running-a-nats-service/nats-kubernetes/helm-charts).  

| Name                                                       | Description                                                                                | Value                                                                                                                                                                                                                                                                                                                                                                               |
| ---------------------------------------------------------- | ------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `nats.nats.jetstream.enabled`                              | Boolean for enabling JetStream.                                                            | `true`                                                                                                                                                                                                                                                                                                                                                                              |
| `nats.nats.limits.maxPayload`                              | Max Payload size for nats                                                                  | `64MB`                                                                                                                                                                                                                                                                                                                                                                              |
| `nats.nats.statefulSetPodLabels.app.kubernetes.io/part-of` | Label to associate nats with GUAC for monitoring purposes                                  | `{"nats":{"jetstream":{"enabled":true},"limits":{"maxPayload":"64MB"},"statefulSetPodLabels":{"app.kubernetes.io/part-of":"guac"}},"natsbox":{"additionalLabels":{"app.kubernetes.io/part-of":"guac"},"podLabels":{"app.kubernetes.io/part-of":"guac"}},"exporter":{"enabled":true,"serviceMonitor":{"enabled":false,"namespace":"monitoring","labels":{"release":"monitoring"}}}}` |
| `nats.natsbox.additionalLabels.app.kubernetes.io/part-of`  | Label to associate natsbox with GUAC for monitoring purposes                               | `guac`                                                                                                                                                                                                                                                                                                                                                                              |
| `nats.natsbox.podLabels.app.kubernetes.io/part-of`         | Label to associate natsbox with GUAC for monitoring purposes                               | `guac`                                                                                                                                                                                                                                                                                                                                                                              |
| `nats.exporter.enabled`                                    | Boolean to enable data collection                                                          | `true`                                                                                                                                                                                                                                                                                                                                                                              |
| `nats.exporter.serviceMonitor.enabled`                     | Boolean to enable nats service monitor                                                     | `false`                                                                                                                                                                                                                                                                                                                                                                             |
| `nats.exporter.serviceMonitor.namespace`                   | nats service monitor namespace - this is for monitoring purposes and is used by Prometheus | `monitoring`                                                                                                                                                                                                                                                                                                                                                                        |
| `nats.exporter.serviceMonitor.labels.release`              | Label to associate nats service monitor with GUAC for monitoring purposes                  | `monitoring`                                                                                                                                                                                                                                                                                                                                                                        |

In order to ensure proper development, run the following

`helm plugin install https://github.com/quintush/helm-unittest`

To Run unit tests

`helm unittest charts/guac -3`